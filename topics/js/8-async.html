<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第 8 章 异步 | yuemeng</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="/favicon.svg">
    <script src="/scripts/scrollToHash.js"></script>
    <meta name="description" content="Truelove always keeps one upward.">
    
    <link rel="preload" href="/assets/css/0.styles.4dfdf963.css" as="style"><link rel="preload" href="/assets/js/app.ecdb2bb9.js" as="script"><link rel="preload" href="/assets/js/2.cda6ce09.js" as="script"><link rel="preload" href="/assets/js/85.5e7818dd.js" as="script"><link rel="prefetch" href="/assets/js/10.c0170a88.js"><link rel="prefetch" href="/assets/js/100.2b7669e3.js"><link rel="prefetch" href="/assets/js/11.1772e714.js"><link rel="prefetch" href="/assets/js/12.c0b4b493.js"><link rel="prefetch" href="/assets/js/13.36460e44.js"><link rel="prefetch" href="/assets/js/14.81e9afc0.js"><link rel="prefetch" href="/assets/js/15.c0259462.js"><link rel="prefetch" href="/assets/js/16.2df928b9.js"><link rel="prefetch" href="/assets/js/17.6619125e.js"><link rel="prefetch" href="/assets/js/18.d0ee4152.js"><link rel="prefetch" href="/assets/js/19.8bc2f46a.js"><link rel="prefetch" href="/assets/js/20.4cd4597e.js"><link rel="prefetch" href="/assets/js/21.9446aad7.js"><link rel="prefetch" href="/assets/js/22.0ac66774.js"><link rel="prefetch" href="/assets/js/23.8b08099b.js"><link rel="prefetch" href="/assets/js/24.23f266ef.js"><link rel="prefetch" href="/assets/js/25.576f2dbd.js"><link rel="prefetch" href="/assets/js/26.93535557.js"><link rel="prefetch" href="/assets/js/27.f87d4dd0.js"><link rel="prefetch" href="/assets/js/28.29123940.js"><link rel="prefetch" href="/assets/js/29.add7930f.js"><link rel="prefetch" href="/assets/js/3.be0b1d21.js"><link rel="prefetch" href="/assets/js/30.5e82b951.js"><link rel="prefetch" href="/assets/js/31.931da19f.js"><link rel="prefetch" href="/assets/js/32.cf595860.js"><link rel="prefetch" href="/assets/js/33.153f1c7f.js"><link rel="prefetch" href="/assets/js/34.e5e1f170.js"><link rel="prefetch" href="/assets/js/35.71248f6f.js"><link rel="prefetch" href="/assets/js/36.fee44eef.js"><link rel="prefetch" href="/assets/js/37.31f2595f.js"><link rel="prefetch" href="/assets/js/38.99569c20.js"><link rel="prefetch" href="/assets/js/39.794d4346.js"><link rel="prefetch" href="/assets/js/4.0d099683.js"><link rel="prefetch" href="/assets/js/40.9980f970.js"><link rel="prefetch" href="/assets/js/41.6f8e933b.js"><link rel="prefetch" href="/assets/js/42.f7c73729.js"><link rel="prefetch" href="/assets/js/43.164592fe.js"><link rel="prefetch" href="/assets/js/44.78ab8d8d.js"><link rel="prefetch" href="/assets/js/45.4cfd8c80.js"><link rel="prefetch" href="/assets/js/46.ba50bca8.js"><link rel="prefetch" href="/assets/js/47.3992d209.js"><link rel="prefetch" href="/assets/js/48.2c61944a.js"><link rel="prefetch" href="/assets/js/49.e9c7b4d7.js"><link rel="prefetch" href="/assets/js/5.c2dbe9b7.js"><link rel="prefetch" href="/assets/js/50.4c754a46.js"><link rel="prefetch" href="/assets/js/51.fb71cc1a.js"><link rel="prefetch" href="/assets/js/52.c275dfb4.js"><link rel="prefetch" href="/assets/js/53.c859a3ef.js"><link rel="prefetch" href="/assets/js/54.7ef1e913.js"><link rel="prefetch" href="/assets/js/55.eda37bf0.js"><link rel="prefetch" href="/assets/js/56.4e998aac.js"><link rel="prefetch" href="/assets/js/57.7342c718.js"><link rel="prefetch" href="/assets/js/58.a33888a7.js"><link rel="prefetch" href="/assets/js/59.d82ce359.js"><link rel="prefetch" href="/assets/js/6.eea35709.js"><link rel="prefetch" href="/assets/js/60.d9de95a4.js"><link rel="prefetch" href="/assets/js/61.2731d14a.js"><link rel="prefetch" href="/assets/js/62.372f2b57.js"><link rel="prefetch" href="/assets/js/63.b32d88df.js"><link rel="prefetch" href="/assets/js/64.86646e04.js"><link rel="prefetch" href="/assets/js/65.ce0fe099.js"><link rel="prefetch" href="/assets/js/66.fc125161.js"><link rel="prefetch" href="/assets/js/67.841ec8b3.js"><link rel="prefetch" href="/assets/js/68.b16f8367.js"><link rel="prefetch" href="/assets/js/69.46c1639c.js"><link rel="prefetch" href="/assets/js/7.0cb74896.js"><link rel="prefetch" href="/assets/js/70.418d468b.js"><link rel="prefetch" href="/assets/js/71.a242d7b7.js"><link rel="prefetch" href="/assets/js/72.19966162.js"><link rel="prefetch" href="/assets/js/73.8788d70d.js"><link rel="prefetch" href="/assets/js/74.2e6c2a6b.js"><link rel="prefetch" href="/assets/js/75.e8afa496.js"><link rel="prefetch" href="/assets/js/76.297ccd10.js"><link rel="prefetch" href="/assets/js/77.76da0924.js"><link rel="prefetch" href="/assets/js/78.ff13e192.js"><link rel="prefetch" href="/assets/js/79.902e67c5.js"><link rel="prefetch" href="/assets/js/8.5a0cb1ae.js"><link rel="prefetch" href="/assets/js/80.494e1ee9.js"><link rel="prefetch" href="/assets/js/81.6c8dc6d4.js"><link rel="prefetch" href="/assets/js/82.b3595b90.js"><link rel="prefetch" href="/assets/js/83.55366323.js"><link rel="prefetch" href="/assets/js/84.34423928.js"><link rel="prefetch" href="/assets/js/86.98f2c49f.js"><link rel="prefetch" href="/assets/js/87.af57678d.js"><link rel="prefetch" href="/assets/js/88.8fbd67e4.js"><link rel="prefetch" href="/assets/js/89.278d649d.js"><link rel="prefetch" href="/assets/js/9.074a4755.js"><link rel="prefetch" href="/assets/js/90.74f33e1f.js"><link rel="prefetch" href="/assets/js/91.66214a62.js"><link rel="prefetch" href="/assets/js/92.e234028f.js"><link rel="prefetch" href="/assets/js/93.3478d95f.js"><link rel="prefetch" href="/assets/js/94.ea06614b.js"><link rel="prefetch" href="/assets/js/95.582aa610.js"><link rel="prefetch" href="/assets/js/96.10ebab9d.js"><link rel="prefetch" href="/assets/js/97.19ff4f64.js"><link rel="prefetch" href="/assets/js/98.6e59a450.js"><link rel="prefetch" href="/assets/js/99.0bb7928d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4dfdf963.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.svg" alt="yuemeng" class="logo"> <span class="site-name can-hide">yuemeng</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端技术专题" class="dropdown-title"><span class="title">前端技术专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端技术专题" class="mobile-dropdown-title"><span class="title">前端技术专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/js/" class="nav-link router-link-active">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/topics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/topics/ts/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/topics/vue/" class="nav-link">
  Vue.js
</a></li><li class="dropdown-item"><!----> <a href="/topics/broswer/" class="nav-link">
  浏览器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/leetcode/" class="nav-link">
  题解
</a></li><li class="dropdown-item"><!----> <a href="/algorithm/summary/" class="nav-link">
  总结
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他专题" class="dropdown-title"><span class="title">其他专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他专题" class="mobile-dropdown-title"><span class="title">其他专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/node/" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/others/rust/" class="nav-link">
  rust
</a></li><li class="dropdown-item"><!----> <a href="/others/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-item"><!----> <a href="/others/nest/" class="nav-link">
  Nest.js
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机科学" class="dropdown-title"><span class="title">计算机科学</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机科学" class="mobile-dropdown-title"><span class="title">计算机科学</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/cp/" class="nav-link">
  编译原理
</a></li><li class="dropdown-item"><!----> <a href="/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/cs/cn.html" class="nav-link">
  计算机网络
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/thoughts/" class="nav-link">
  随想
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端技术专题" class="dropdown-title"><span class="title">前端技术专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端技术专题" class="mobile-dropdown-title"><span class="title">前端技术专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/js/" class="nav-link router-link-active">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/topics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/topics/ts/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/topics/vue/" class="nav-link">
  Vue.js
</a></li><li class="dropdown-item"><!----> <a href="/topics/broswer/" class="nav-link">
  浏览器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/leetcode/" class="nav-link">
  题解
</a></li><li class="dropdown-item"><!----> <a href="/algorithm/summary/" class="nav-link">
  总结
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他专题" class="dropdown-title"><span class="title">其他专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他专题" class="mobile-dropdown-title"><span class="title">其他专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/node/" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/others/rust/" class="nav-link">
  rust
</a></li><li class="dropdown-item"><!----> <a href="/others/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-item"><!----> <a href="/others/nest/" class="nav-link">
  Nest.js
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机科学" class="dropdown-title"><span class="title">计算机科学</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机科学" class="mobile-dropdown-title"><span class="title">计算机科学</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/cp/" class="nav-link">
  编译原理
</a></li><li class="dropdown-item"><!----> <a href="/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/cs/cn.html" class="nav-link">
  计算机网络
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/thoughts/" class="nav-link">
  随想
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/topics/js/" aria-current="page" class="sidebar-link">Javascript</a></li><li><a href="/topics/js/1-basic.html" class="sidebar-link">第 1 章 基础部分</a></li><li><a href="/topics/js/2-object.html" class="sidebar-link">第 2 章 对象</a></li><li><a href="/topics/js/3-array.html" class="sidebar-link">第 3 章 数组</a></li><li><a href="/topics/js/4-function.html" class="sidebar-link">第 4 章 函数</a></li><li><a href="/topics/js/5-class.html" class="sidebar-link">第 5 章 类</a></li><li><a href="/topics/js/6-module.html" class="sidebar-link">第 6 章 模块</a></li><li><a href="/topics/js/7-iterator.html" class="sidebar-link">第 7 章 迭代器</a></li><li><a href="/topics/js/8-async.html" aria-current="page" class="active sidebar-link">第 8 章 异步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_1、关于异步" class="sidebar-link">1、关于异步</a></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_2、注册方式" class="sidebar-link">2、注册方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_1-浏览器环境" class="sidebar-link">（1）浏览器环境</a></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_2-node-环境" class="sidebar-link">（2）Node 环境</a></li></ul></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_3、回调函数-api-方式" class="sidebar-link">3、回调函数 API 方式</a></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_4、promise-方式" class="sidebar-link">4、Promise 方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_1-使用-promise" class="sidebar-link">（1）使用 Promise</a></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_2-并行-promise" class="sidebar-link">（2）并行 Promise</a></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_3-创建期约" class="sidebar-link">（3）创建期约</a></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_4-实现-promsie" class="sidebar-link">（4）实现 Promsie</a></li></ul></li><li class="sidebar-sub-header"><a href="/topics/js/8-async.html#_5、async-和-await-方式" class="sidebar-link">5、async 和 await 方式</a></li></ul></li><li><a href="/topics/js/9-meta.html" class="sidebar-link">第 9 章 元编程</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第-8-章-异步"><a href="#第-8-章-异步" class="header-anchor">#</a> 第 8 章 异步</h1> <h2 id="_1、关于异步"><a href="#_1、关于异步" class="header-anchor">#</a> 1、关于异步</h2> <p>究竟什么叫异步？我们常常能给出异步的场景，却很难给出确切的定义，我在这里勉强描述一番：<strong>异步是一段不知何时执行结束的过程和为响应这段过程而定义的回调函数</strong>。所以异步操作包括异步执行本身，和异步完成后的回调函数。譬如我们发出一个 ajax 数据请求，这个请求过程是异步的，同时我们还要预先定义好对请求结果的处理，这个处理也是异步的。</p> <p>关于异步我们主要学习异步代码的写法，大概分为以下几类：</p> <ul><li>为事件源注册<code>事件处理程序</code> <ul><li><code>addEventListener</code>('事件'，处理函数)</li> <li>使用<code>on</code>形式</li></ul></li> <li><code>回调函数</code>API</li> <li>基于<code>Promise</code></li> <li>使用<code>async</code>和<code>await</code></li></ul> <p>以下围绕这几种形式介绍。</p> <blockquote><p>在不同环境下，以上各种方式并非总是可用的。</p></blockquote> <h2 id="_2、注册方式"><a href="#_2、注册方式" class="header-anchor">#</a> 2、注册方式</h2> <h3 id="_1-浏览器环境"><a href="#_1-浏览器环境" class="header-anchor">#</a> （1）浏览器环境</h3> <h4 id="_1-addeventlistener"><a href="#_1-addeventlistener" class="header-anchor">#</a> ① addEventListener</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> okay <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
okay<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> applyUpdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-on-事件属性"><a href="#_2-on-事件属性" class="header-anchor">#</a> ② on 事件属性</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> okay <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
okay<span class="token punctuation">.</span>onclick <span class="token operator">=</span> applyUpdata<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>两种方式的效果是相同的，可见第二种方式更简单，但一种事件只能添加一个事件处理函数，而第一种可以添加多个。</p> <p>这两种方式定义的回调函数中的 this 都是指向被绑定的对象，因为最后是其调用的这些函数。</p></blockquote> <h3 id="_2-node-环境"><a href="#_2-node-环境" class="header-anchor">#</a> （2）Node 环境</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getText</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    request <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">,</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>这里的<code>on()</code>类似于上面的<code>addListener()</code>。</p></blockquote> <h2 id="_3、回调函数-api-方式"><a href="#_3、回调函数-api-方式" class="header-anchor">#</a> 3、回调函数 API 方式</h2> <p>回调函数 API 方式是十分常用的方式，它是把回调函数直接作为参数传入到异步函数中，省却了手动注册处理函数的过程。但注意这种方式是官方针对常用异步函数提供的一套简洁的 API，常常是针对那些只具有成功和失败事件的异步函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;config.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> text</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>事实上，在很长的一段时间这是异步函数最常用的写法。但也有如下十分明显的缺陷：</p></blockquote> <p>首先这种写法很容易写出回调地狱，即多级回调函数的嵌套，代码可读性很不好。再者这种写法很不利于异常捕获，因为回调函数中的异常是没法传播到操作发起者的，我们需要再每一级回调函数使用异常捕获，我常常不是我们希望的。于是<code>Promise</code>很好地解决了这两个问题。</p> <h2 id="_4、promise-方式"><a href="#_4、promise-方式" class="header-anchor">#</a> 4、Promise 方式</h2> <blockquote><p>关于期约，我们先来使用它，再考虑实现它。</p></blockquote> <h3 id="_1-使用-promise"><a href="#_1-使用-promise" class="header-anchor">#</a> （1）使用 Promise</h3> <p>期约表示在期约对象被创建之后发生的异步计算的未来结果。期约的生命周期从创建完成的待定（<code>pending</code>）状态到异步操作完成后的落定（<code>settle</code>）状态，其中落定包括执行成功的兑现（<code>fulfill</code>），又称为解决（<code>resolve</code>），和执行失败的拒绝（<code>reject</code>）。</p> <p>下面先把期约用起来：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fecth</span><span class="token punctuation">(</span><span class="token string">&quot;/url&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 发请求，返回Promise对象</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span>
      <span class="token comment">// 404等错误</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!==</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 格式不对</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected JSON, got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析数据，返回Promise对象</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">profile</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>profile<span class="token punctuation">)</span> <span class="token function">displayUserProfile</span><span class="token punctuation">(</span>profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">displayLoggedOutProfilePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">NetworkError</span><span class="token punctuation">)</span>
      <span class="token function">displayErrorMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Check your internet conection.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TypeError</span><span class="token punctuation">)</span>
      <span class="token function">displayErrorMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Something is wrong with our server!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从上面的代码我们可以总结如下几点：</p> <ul><li>Promise 落定的<code>兑现结果</code>作为实参传递给<code>then</code>的第一个参数，<code>reject</code>的结果（异常）作为实参传递给<code>catch</code>。</li> <li><code>then</code>方法的返回值默认为<code>resolve</code>结果为其第一个参数的落定的<code>Promise</code>对象，该值可以被返回值覆盖，如果返回一个新的<code>Promise</code>，就实现了<code>期约链</code>。</li></ul> <blockquote><p>期约看起来很复杂，其实就这么多东西，恰恰是<code>then</code>的返回值更容易让人迷惑。</p></blockquote> <h3 id="_2-并行-promise"><a href="#_2-并行-promise" class="header-anchor">#</a> （2）并行 Promise</h3> <h4 id="_1-promise-all"><a href="#_1-promise-all" class="header-anchor">#</a> ① Promise.all()</h4> <p>接受一个期约对象的数组作为输入，返回一个期约，如果输入的期约中的任意一个被拒绝，返回的期约也被拒绝，否则返回的期约以每个期约兑现值的数组兑现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
promises <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">bodies</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>看起来把包含 then 的期约对象传进去好像有点问题，事实上我们应该明确期约的<code>创建时机</code>和<code>执行时机</code>，期约的创建是沿着代码执行的流程顺序进行的，但直到同步代码执行完毕才开始执行期约（异步代码），<code>Promise.all()</code>只是做了些辅助工作，帮助把多个期约合并成一个看待，而本身并没有异步的效果。</p></blockquote> <h4 id="_2-promise-allsettled"><a href="#_2-promise-allsettled" class="header-anchor">#</a> ② Promise.allSettled()</h4> <p>类似于上面的函数，该函数也接受一个期约对象数组。但该函数永远不会返回一个被拒绝的期约，它会等待所有期约落定，返回的结果为一个数组，数组的元素包含期约落定状态和兑现结果（如果有）的属性。</p> <h4 id="_3-promise-race"><a href="#_3-promise-race" class="header-anchor">#</a> ③ Promise.race()</h4> <p>该函数也接受一个期约数组，但只返回最快落定的那个期约对象。从名字可以看出来。</p> <h3 id="_3-创建期约"><a href="#_3-创建期约" class="header-anchor">#</a> （3）创建期约</h3> <p>可以通过创建期约，自己实现异步函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token parameter">duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>duration <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Time travel not yet implements&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-实现-promsie"><a href="#_4-实现-promsie" class="header-anchor">#</a> （4）实现 Promsie</h3> <h4 id="版本1"><a href="#版本1" class="header-anchor">#</a> 版本1</h4> <p>https://zhuanlan.zhihu.com/p/58428287</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resolve</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// INFO then 用来收集回调</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// INFO resolve 即把异步结果传递给回到函数</span>
  <span class="token function">_resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;5秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tip</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_5、async-和-await-方式"><a href="#_5、async-和-await-方式" class="header-anchor">#</a> 5、async 和 await 方式</h2> <p><code>async</code>和<code>await</code>关键字写异步代码的方式是在期约后提出的，用来简化并隐藏期约，还是为了可读性考虑的，况且引入期约的确比较难以理解。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getHighScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/api/user/profile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> profile <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> profile<span class="token punctuation">.</span>highScore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>显然我们通过<code>await</code>标识异步代码，但要注意只能在<code>async</code>标识的函数中使用，此时代码块中处于<code>await</code>代码之后的内容会等待异步代码的结果，相当于写作同步格式的回调函数。函数返回的是落成的期约对象。</p> <blockquote><p><code>await</code>后面如果不是<code>Promise</code>对象，会自动转化。</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/28/2022, 10:40:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/topics/js/7-iterator.html" class="prev">
        第 7 章 迭代器
      </a></span> <span class="next"><a href="/topics/js/9-meta.html">
        第 9 章 元编程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ecdb2bb9.js" defer></script><script src="/assets/js/2.cda6ce09.js" defer></script><script src="/assets/js/85.5e7818dd.js" defer></script>
  </body>
</html>
