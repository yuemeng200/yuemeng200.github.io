<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第 8 章 vue3 | yuemeng</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="/favicon.svg">
    <script src="/scripts/scrollToHash.js"></script>
    <meta name="description" content="Truelove always keeps one upward.">
    
    <link rel="preload" href="/assets/css/0.styles.1b9b59ba.css" as="style"><link rel="preload" href="/assets/js/app.d26133cf.js" as="script"><link rel="preload" href="/assets/js/2.bc6cc53f.js" as="script"><link rel="preload" href="/assets/js/15.e2b6965a.js" as="script"><link rel="prefetch" href="/assets/js/10.8857c39c.js"><link rel="prefetch" href="/assets/js/11.57ad102b.js"><link rel="prefetch" href="/assets/js/12.960a8d83.js"><link rel="prefetch" href="/assets/js/13.171df62e.js"><link rel="prefetch" href="/assets/js/14.71ea6d44.js"><link rel="prefetch" href="/assets/js/16.65e968fc.js"><link rel="prefetch" href="/assets/js/17.49efa82e.js"><link rel="prefetch" href="/assets/js/18.d8f30cc1.js"><link rel="prefetch" href="/assets/js/19.24b54144.js"><link rel="prefetch" href="/assets/js/20.26e13ea0.js"><link rel="prefetch" href="/assets/js/21.b1e433f5.js"><link rel="prefetch" href="/assets/js/22.195d79f1.js"><link rel="prefetch" href="/assets/js/23.a0052f66.js"><link rel="prefetch" href="/assets/js/24.829126fd.js"><link rel="prefetch" href="/assets/js/25.d2e8f019.js"><link rel="prefetch" href="/assets/js/26.6f394325.js"><link rel="prefetch" href="/assets/js/27.c9f67395.js"><link rel="prefetch" href="/assets/js/28.13408dc7.js"><link rel="prefetch" href="/assets/js/29.2405891a.js"><link rel="prefetch" href="/assets/js/3.b00e0f01.js"><link rel="prefetch" href="/assets/js/30.07c1e3e8.js"><link rel="prefetch" href="/assets/js/31.51f08698.js"><link rel="prefetch" href="/assets/js/32.3df01808.js"><link rel="prefetch" href="/assets/js/33.dd06b81f.js"><link rel="prefetch" href="/assets/js/34.dc28284a.js"><link rel="prefetch" href="/assets/js/35.639f72f2.js"><link rel="prefetch" href="/assets/js/36.af29550d.js"><link rel="prefetch" href="/assets/js/37.df88ade0.js"><link rel="prefetch" href="/assets/js/38.a7f9d206.js"><link rel="prefetch" href="/assets/js/39.4498ea4d.js"><link rel="prefetch" href="/assets/js/4.e07b56f2.js"><link rel="prefetch" href="/assets/js/40.8650ecf6.js"><link rel="prefetch" href="/assets/js/41.e0a87dee.js"><link rel="prefetch" href="/assets/js/42.9675c1f2.js"><link rel="prefetch" href="/assets/js/43.b7c124ca.js"><link rel="prefetch" href="/assets/js/44.4a50a2d8.js"><link rel="prefetch" href="/assets/js/45.f7e27e40.js"><link rel="prefetch" href="/assets/js/46.11cdd3f3.js"><link rel="prefetch" href="/assets/js/47.a696abc3.js"><link rel="prefetch" href="/assets/js/48.a8abacda.js"><link rel="prefetch" href="/assets/js/49.f55d0e9f.js"><link rel="prefetch" href="/assets/js/5.19be7f9f.js"><link rel="prefetch" href="/assets/js/50.78ac574f.js"><link rel="prefetch" href="/assets/js/51.55e50803.js"><link rel="prefetch" href="/assets/js/52.4f78a14d.js"><link rel="prefetch" href="/assets/js/53.ab4b8f82.js"><link rel="prefetch" href="/assets/js/54.c4fc7fc6.js"><link rel="prefetch" href="/assets/js/55.12966bdb.js"><link rel="prefetch" href="/assets/js/56.02462ba5.js"><link rel="prefetch" href="/assets/js/6.ec68c2a3.js"><link rel="prefetch" href="/assets/js/7.865c11cd.js"><link rel="prefetch" href="/assets/js/8.a5fd7c60.js"><link rel="prefetch" href="/assets/js/9.eb312863.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b9b59ba.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.svg" alt="yuemeng" class="logo"> <span class="site-name can-hide">yuemeng</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端技术专题" class="dropdown-title"><span class="title">前端技术专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端技术专题" class="mobile-dropdown-title"><span class="title">前端技术专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/js/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/topics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/topics/ts/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/topics/vue/" class="nav-link router-link-active">
  Vue.js
</a></li><li class="dropdown-item"><!----> <a href="/topics/broswer/" class="nav-link">
  浏览器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/leetcode/" class="nav-link">
  题解
</a></li><li class="dropdown-item"><!----> <a href="/algorithm/summary/" class="nav-link">
  总结
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他专题" class="dropdown-title"><span class="title">其他专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他专题" class="mobile-dropdown-title"><span class="title">其他专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/node/" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/others/rust/" class="nav-link">
  rust
</a></li><li class="dropdown-item"><!----> <a href="/others/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-item"><!----> <a href="/others/nest/" class="nav-link">
  Nest.js
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机科学" class="dropdown-title"><span class="title">计算机科学</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机科学" class="mobile-dropdown-title"><span class="title">计算机科学</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/cp/" class="nav-link">
  编译原理
</a></li><li class="dropdown-item"><!----> <a href="/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/cs/cn.html" class="nav-link">
  计算机网络
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/thoughts/" class="nav-link">
  随想
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端技术专题" class="dropdown-title"><span class="title">前端技术专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端技术专题" class="mobile-dropdown-title"><span class="title">前端技术专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/js/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/topics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/topics/ts/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/topics/vue/" class="nav-link router-link-active">
  Vue.js
</a></li><li class="dropdown-item"><!----> <a href="/topics/broswer/" class="nav-link">
  浏览器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/leetcode/" class="nav-link">
  题解
</a></li><li class="dropdown-item"><!----> <a href="/algorithm/summary/" class="nav-link">
  总结
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他专题" class="dropdown-title"><span class="title">其他专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他专题" class="mobile-dropdown-title"><span class="title">其他专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/node/" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/others/rust/" class="nav-link">
  rust
</a></li><li class="dropdown-item"><!----> <a href="/others/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-item"><!----> <a href="/others/nest/" class="nav-link">
  Nest.js
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机科学" class="dropdown-title"><span class="title">计算机科学</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机科学" class="mobile-dropdown-title"><span class="title">计算机科学</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cs/cp/" class="nav-link">
  编译原理
</a></li><li class="dropdown-item"><!----> <a href="/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/cs/cn.html" class="nav-link">
  计算机网络
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/thoughts/" class="nav-link">
  随想
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/topics/vue/" aria-current="page" class="sidebar-link">Vue.js</a></li><li><a href="/topics/vue/basic.html" class="sidebar-link">第 1 章 基础知识</a></li><li><a href="/topics/vue/router.html" class="sidebar-link">第 2 章 vue-router</a></li><li><a href="/topics/vue/store.html" class="sidebar-link">第 3 章 vuex</a></li><li><a href="/topics/vue/theory.html" class="sidebar-link">第 4 章 进入 vue 原理</a></li><li><a href="/topics/vue/cli.html" class="sidebar-link">第5章 CLI 构建工具</a></li><li><a href="/topics/vue/tools.html" class="sidebar-link">第 6 章 常用依赖</a></li><li><a href="/topics/vue/other.html" class="sidebar-link">第 7 章 其他技术</a></li><li><a href="/topics/vue/vue3.html" aria-current="page" class="active sidebar-link">第 8 章 vue3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_1、概览" class="sidebar-link">1、概览</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_1-优化" class="sidebar-link">(1) 优化</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_2-新特性" class="sidebar-link">(2) 新特性</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_3-非兼容更改" class="sidebar-link">(3) 非兼容更改</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_4-移除" class="sidebar-link">(4) 移除</a></li></ul></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_2、组合式-api" class="sidebar-link">2、组合式 API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_1-为什么需要" class="sidebar-link">(1) 为什么需要</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_2-响应式" class="sidebar-link">(2) 响应式</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_3-setup" class="sidebar-link">(3) setup</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_4-生命周期钩子" class="sidebar-link">(4) 生命周期钩子</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_5-provide-和-inject" class="sidebar-link">(5) provide 和 inject</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_6-响应式计算和侦听" class="sidebar-link">(6) 响应式计算和侦听</a></li></ul></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_3、其他新特性" class="sidebar-link">3、其他新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_1-teleport" class="sidebar-link">(1) Teleport</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_2-fragment" class="sidebar-link">(2) Fragment</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_3-事件验证" class="sidebar-link">(3) 事件验证</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_4" class="sidebar-link">(4)</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_5-style-相关" class="sidebar-link">(5) style 相关</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_7-suspense" class="sidebar-link">(7) Suspense</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_8-tree-shaking" class="sidebar-link">(8) tree-shaking</a></li></ul></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_4、非兼容更改" class="sidebar-link">4、非兼容更改</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_1-全局-api-更改" class="sidebar-link">(1) 全局 API 更改</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_2-v-model-替换-sync" class="sidebar-link">(2) v-model 替换.sync</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_3-v-if-和-v-for-优先级" class="sidebar-link">(3) v-if 和 v-for 优先级</a></li><li class="sidebar-sub-header"><a href="/topics/vue/vue3.html#_4-native" class="sidebar-link">(4) .native</a></li></ul></li></ul></li><li><a href="/topics/vue/vite.html" class="sidebar-link">第 9 章 Vite</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第-8-章-vue3"><a href="#第-8-章-vue3" class="header-anchor">#</a> 第 8 章 vue3</h1> <h2 id="_1、概览"><a href="#_1、概览" class="header-anchor">#</a> 1、概览</h2> <h3 id="_1-优化"><a href="#_1-优化" class="header-anchor">#</a> (1) 优化</h3> <p>速度更快：</p> <ul><li>重写了虚拟 dom 的实现</li> <li>模板编译优化</li> <li>更高效的组件初始化</li> <li>update 性能提升</li> <li>SSR 速度提升</li></ul> <p>打包更小：</p> <ul><li>使用 webpack 的 tree-shaking</li></ul> <p>更易维护：</p> <ul><li>options API</li> <li>逻辑组合与复用</li> <li>配合其他框架</li> <li>更好的 ts 支持</li></ul> <p>开放更多底层功能：</p> <ul><li>自定义渲染 API</li> <li>暴露响应式 API</li></ul> <h3 id="_2-新特性"><a href="#_2-新特性" class="header-anchor">#</a> (2) 新特性</h3> <ul><li>framents：支持多根节点</li> <li>teleport：组件任意门</li> <li>createRenderer：构建自定义渲染器</li> <li>composition：逻辑组合、复用和管理</li></ul> <h3 id="_3-非兼容更改"><a href="#_3-非兼容更改" class="header-anchor">#</a> (3) 非兼容更改</h3> <h3 id="_4-移除"><a href="#_4-移除" class="header-anchor">#</a> (4) 移除</h3> <ul><li><code>$on</code>、<code>$once</code>和<code>$off</code>实例方法</li> <li>过滤器</li> <li><code>$destroy</code></li></ul> <h2 id="_2、组合式-api"><a href="#_2、组合式-api" class="header-anchor">#</a> 2、组合式 API</h2> <h3 id="_1-为什么需要"><a href="#_1-为什么需要" class="header-anchor">#</a> (1) 为什么需要</h3> <p>vue2 是以组件为代码组织划分的最小单元，同一组件下的相同类别的功能如<code>data</code>、<code>method</code>被统一管理，本质上是采用声明式的。但事实上就是在一个组件内部也是可以划分出若干个逻辑功能点，每个功能点可能同时依赖着<code>data</code>、<code>method</code> 和<code>watch</code>等，有时候按照功能点来组织代码会更容易复用和维护。组合式 API 就是为了解决这个问题。
组件通过调用功能点来组织代码，减小了耦合度。所有调用操作被写在组件的<code>setup(props)</code>选项中，该函数的返回值被绑定到组件实例上调用。</p> <blockquote><p><code>setup</code>的执行实际发生在<code>props</code>获取后，组件实例创建之前，所以不要在 setup 中调用组件实例。</p></blockquote> <h3 id="_2-响应式"><a href="#_2-响应式" class="header-anchor">#</a> (2) 响应式</h3> <h4 id="_1-构建响应式"><a href="#_1-构建响应式" class="header-anchor">#</a> ① 构建响应式</h4> <p>第一个要考虑的问题恐怕就是怎么构造响应式状态并向组件传递。
首先是构建一个响应式的对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 响应式状态</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此时导出的<code>state</code>就会被挂载到<code>data</code>中。
如果不是对象呢，只需要一个基本类型的值的时候：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此时<code>count</code>会被封装为一个响应式对象，具有唯一的<code>value</code>属性，所以在访问和修改时不要忘记操作<code>value</code>。这样感觉有点麻烦，所有在从<code>setup</code>中导出时会对响应式值自动解包，在组件中使用时无需使用<code>value</code>。
除非<code>ref</code>作为深层属性时，此时无法自动解包，但作为响应式对象的属性时也会自动解包。</p> <blockquote><p><code>ref</code>也是可以构造对象的响应式的，也是通过 value 访问，但似乎没有这样使用的必要。</p></blockquote> <p>在使用 ES6 对响应式对象解构时将会消除响应式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> title <span class="token punctuation">}</span> <span class="token operator">=</span> props <span class="token comment">// title 不再具有响应式</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时可以使用<code>toRefs(props)</code>，它会对解构后的对象添加响应式。
如果只是访问响应式对象的属性作为新的状态呢？如果该属性是对象不需要做任何处理，但如果是基本类型时：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提醒</p> <p>永远记得：真正的<code>响应式</code>描述的是视图和状态的关系，状态和状态之间事实上没有啥响应式一说，那叫做<code>引用</code>，在内存中共享一块堆空间，对于一个经过<code>reactive</code>或<code>ref</code>处理过的数据自然会变成对象，但响应式对象并不需要给它的值属性也设置为响应呀，因为已经足够监听到对它的操作了。
为什么在<code>method</code>中定义的方法可以直接通过<code>this.state</code>直接赋值修改基本类型的状态，而在<code>setup</code>中却需要<code>state.value</code>呢？因为前者能监听到，后者监听不到了，不管对任何东西做赋值，只要是通过<code>对象.属性</code>的都能够被监听到，直接赋值肯定没办法监听。</p></div> <p>除此之外 vue3 还提供了一个<code>readonly()</code>函数，该函数依然返回响应式对象的引用，但是只读的。</p> <h4 id="_2-原理"><a href="#_2-原理" class="header-anchor">#</a> ② 原理</h4> <p>通过<code>ref()</code>构建的响应式依然适用<code>Object.defineProperty()</code>，但是适用<code>reactive()</code>时是使用 ES6 的<code>Proxy</code>实现拦截，并在操作时使用<code>Reflect</code>。</p> <h3 id="_3-setup"><a href="#_3-setup" class="header-anchor">#</a> (3) setup</h3> <p>setup 可以接收两个参数<code>props</code>和<code>context</code>，也可以直接返回一个渲染函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> expose <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">++</span>count<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

    <span class="token function">expose</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      increment<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>除此之外这里还向父组件暴露了<code>increment</code>方法，可以通过<code>ref</code>调用。</p> <h3 id="_4-生命周期钩子"><a href="#_4-生命周期钩子" class="header-anchor">#</a> (4) 生命周期钩子</h3> <p>setup 中也能调用声明周期钩子：</p> <blockquote><p>因为 setup 是围绕 beforeCreate 和 created 生命周期钩子运行的，所以不需要显式地定义它们。换句话说，在这些钩子中编写的任何代码都应该直接在 setup 函数中编写。</p></blockquote> <p><img src="/assets/img/image-20220330114652850.13949f51.png" alt="image-20220330114652850"></p> <h3 id="_5-provide-和-inject"><a href="#_5-provide-和-inject" class="header-anchor">#</a> (5) provide 和 inject</h3> <p>在 vue2 中，我们并不常用<code>provide</code>和<code>inject</code>进行组件通信，因为他们不是响应式的，这在 vue3 中被完美解决了。</p> <p>父组件使用<code>provide</code>，并提供修改方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    MyMarker<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">&quot;North Pole&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> geolocation <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">longitude</span><span class="token operator">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
      <span class="token literal-property property">latitude</span><span class="token operator">:</span> <span class="token number">135</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">updateLocation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;South Pole&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">,</span> <span class="token function">readonly</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&quot;geolocation&quot;</span><span class="token punctuation">,</span> <span class="token function">readonly</span><span class="token punctuation">(</span>geolocation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&quot;updateLocation&quot;</span><span class="token punctuation">,</span> updateLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>子组件注入，有个设置默认值的可选参数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userLocation <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;The Universe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> userGeolocation <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;geolocation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> updateUserLocation <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;updateLocation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      userLocation<span class="token punctuation">,</span>
      userGeolocation<span class="token punctuation">,</span>
      updateUserLocation<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-响应式计算和侦听"><a href="#_6-响应式计算和侦听" class="header-anchor">#</a> (6) 响应式计算和侦听</h3> <h4 id="_1-computed"><a href="#_1-computed" class="header-anchor">#</a> ① computed</h4> <p><code>computed</code>也能调试<code>get</code>和<code>set</code>了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> plusOne <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">onTrack</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当 count.value 作为依赖被追踪时触发</span>
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当 count.value 被修改时触发</span>
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-watcheffect"><a href="#_2-watcheffect" class="header-anchor">#</a> ② watchEffect</h4> <p>侦听函数体依赖变化并调用函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>组件卸载时自动停止，也可以手动停止：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stop <span class="token operator">=</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>
<span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>同时 watchEffect 还能执行清除工作，在下次回调开始前或停止操作时执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">onInvalidate</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">performAsyncOperation</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// id has changed or watcher is stopped.</span>
    <span class="token comment">// invalidate previously pending async operation</span>
    token<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>默认触发时机是在一个<code>tick</code>的模板<code>update</code>之前，可以修改<code>flush</code>为<code>post</code>或者<code>sync</code>，默认为<code>pre</code>。</p> <h4 id="_3-watch"><a href="#_3-watch" class="header-anchor">#</a> ③ watch</h4> <p>相比于<code>watchEffect</code>：</p> <ul><li>支持懒执行</li> <li>精细化监听状态</li> <li>侦听变化前后值</li></ul> <h5 id="侦听值"><a href="#侦听值" class="header-anchor">#</a> 侦听值</h5> <p>第一个参数可以是<code>getter</code>或者<code>ref</code>。
想一次监听多个时传入数组即可，注意在一个<code>tick</code>中默认只会触发一次，通过<code>sync</code>或者<code>nextTick</code>可以强制每次触发。</p> <h5 id="监听对象"><a href="#监听对象" class="header-anchor">#</a> 监听对象</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watch</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;deep&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>name<span class="token punctuation">,</span> prevState<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">deep</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意此时还是获取不到过去 state 的值的，可使用深拷贝：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watch</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>name<span class="token punctuation">,</span> prevState<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>除此之外，<code>watchEffect</code>中的停止监听、清理副作用、调试也是适用的。</p> <h2 id="_3、其他新特性"><a href="#_3、其他新特性" class="header-anchor">#</a> 3、其他新特性</h2> <h3 id="_1-teleport"><a href="#_1-teleport" class="header-anchor">#</a> (1) Teleport</h3> <p>有这样一种常见场景，组件中有一个按钮，点击后显示一个全屏弹框，这可以通过 css 的 fixed 定位实现，但事实上我们真正需要的是一个组件任意门。<code>teleport</code>可以实现这个功能。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modalOpen = true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  Open full screen modal! (With teleport!)
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>teleport</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>body<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modalOpen<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modal<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      I'm a teleported modal! (My parent is &quot;body&quot;)
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modalOpen = false<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Close<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>teleport</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>to</code>属性是个选择器，表示其渲染的父级元素。</p> <h3 id="_2-fragment"><a href="#_2-fragment" class="header-anchor">#</a> (2) Fragment</h3> <p>即组件不再需要根元素。</p> <h3 id="_3-事件验证"><a href="#_3-事件验证" class="header-anchor">#</a> (3) 事件验证</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token literal-property property">emits</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有验证</span>
    <span class="token literal-property property">click</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token comment">// 验证 submit 事件</span>
    <span class="token function-variable function">submit</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>email <span class="token operator">&amp;&amp;</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Invalid submit event payload!'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="_4"><a href="#_4" class="header-anchor">#</a> (4) <script setup=""></script></h3></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">4/3/2022, 11:19:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/topics/vue/other.html" class="prev">
        第 7 章 其他技术
      </a></span> <span class="next"><a href="/topics/vue/vite.html">
        第 9 章 Vite
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d26133cf.js" defer></script><script src="/assets/js/2.bc6cc53f.js" defer></script><script src="/assets/js/15.e2b6965a.js" defer></script>
  </body>
</html>
