<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第4章 进入vue原理 | yuemeng</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="/favicon.svg">
    <script src="/scripts/scrollToHash.js"></script>
    <meta name="description" content="满地都是六便士，捡干净以后，抬头看见了月亮。">
    
    <link rel="preload" href="/assets/css/0.styles.a871159c.css" as="style"><link rel="preload" href="/assets/js/app.3e77bb48.js" as="script"><link rel="preload" href="/assets/js/2.e6646181.js" as="script"><link rel="preload" href="/assets/js/33.f3b0c2ca.js" as="script"><link rel="prefetch" href="/assets/js/10.26a5d24d.js"><link rel="prefetch" href="/assets/js/11.abe02e29.js"><link rel="prefetch" href="/assets/js/12.9b7e3244.js"><link rel="prefetch" href="/assets/js/13.6b8a637e.js"><link rel="prefetch" href="/assets/js/14.02ef5dcd.js"><link rel="prefetch" href="/assets/js/15.8f1b9216.js"><link rel="prefetch" href="/assets/js/16.25c4811e.js"><link rel="prefetch" href="/assets/js/17.7b01c315.js"><link rel="prefetch" href="/assets/js/18.f02eab57.js"><link rel="prefetch" href="/assets/js/19.1f69dd54.js"><link rel="prefetch" href="/assets/js/20.009c055e.js"><link rel="prefetch" href="/assets/js/21.15b7ac4b.js"><link rel="prefetch" href="/assets/js/22.b4b936f7.js"><link rel="prefetch" href="/assets/js/23.913a1ed6.js"><link rel="prefetch" href="/assets/js/24.bffa56f4.js"><link rel="prefetch" href="/assets/js/25.4988fe0c.js"><link rel="prefetch" href="/assets/js/26.77f5ed97.js"><link rel="prefetch" href="/assets/js/27.831210ba.js"><link rel="prefetch" href="/assets/js/28.9f73cfba.js"><link rel="prefetch" href="/assets/js/29.a7c8ca6d.js"><link rel="prefetch" href="/assets/js/3.ae9b890a.js"><link rel="prefetch" href="/assets/js/30.b6d7b1de.js"><link rel="prefetch" href="/assets/js/31.91a08ece.js"><link rel="prefetch" href="/assets/js/32.5ad1ae78.js"><link rel="prefetch" href="/assets/js/4.a9930409.js"><link rel="prefetch" href="/assets/js/5.83dab69b.js"><link rel="prefetch" href="/assets/js/6.6b373152.js"><link rel="prefetch" href="/assets/js/7.8757b002.js"><link rel="prefetch" href="/assets/js/8.620411d0.js"><link rel="prefetch" href="/assets/js/9.b4b22fe5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a871159c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.svg" alt="yuemeng" class="logo"> <span class="site-name can-hide">yuemeng</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端技术专题" class="dropdown-title"><span class="title">前端技术专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端技术专题" class="mobile-dropdown-title"><span class="title">前端技术专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/js/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/topics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/topics/ts/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/topics/vue/" class="nav-link router-link-active">
  Vue.js
</a></li><li class="dropdown-item"><!----> <a href="/topics/broswer/" class="nav-link">
  浏览器
</a></li></ul></div></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他专题" class="dropdown-title"><span class="title">其他专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他专题" class="mobile-dropdown-title"><span class="title">其他专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/node/" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/others/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-item"><!----> <a href="/others/nest/" class="nav-link">
  Nest.js
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/thoughts/" class="nav-link">
  随想
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端技术专题" class="dropdown-title"><span class="title">前端技术专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端技术专题" class="mobile-dropdown-title"><span class="title">前端技术专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/js/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/topics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/topics/ts/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/topics/vue/" class="nav-link router-link-active">
  Vue.js
</a></li><li class="dropdown-item"><!----> <a href="/topics/broswer/" class="nav-link">
  浏览器
</a></li></ul></div></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他专题" class="dropdown-title"><span class="title">其他专题</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他专题" class="mobile-dropdown-title"><span class="title">其他专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/others/node/" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/others/electron/" class="nav-link">
  Electron
</a></li><li class="dropdown-item"><!----> <a href="/others/nest/" class="nav-link">
  Nest.js
</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/thoughts/" class="nav-link">
  随想
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/topics/vue/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/topics/vue/basic.html" class="sidebar-link">第 1 章 基础知识</a></li><li><a href="/topics/vue/router.html" class="sidebar-link">第2章 vue-router</a></li><li><a href="/topics/vue/store.html" class="sidebar-link">第 3 章 vuex</a></li><li><a href="/topics/vue/theory.html" aria-current="page" class="active sidebar-link">第4章 进入vue原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/vue/theory.html#_1、响应式原理" class="sidebar-link">1、响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/vue/theory.html#_1-对象的变化侦测" class="sidebar-link">(1) 对象的变化侦测</a></li><li class="sidebar-sub-header"><a href="/topics/vue/theory.html#_2-数组的变化侦测" class="sidebar-link">(2) 数组的变化侦测</a></li><li class="sidebar-sub-header"><a href="/topics/vue/theory.html#_3-vm-watch的实现" class="sidebar-link">(3) vm.$watch的实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/topics/vue/theory.html#_2、虚拟dom" class="sidebar-link">2、虚拟dom</a></li><li class="sidebar-sub-header"><a href="/topics/vue/theory.html#_3、diff算法" class="sidebar-link">3、Diff算法</a></li></ul></li><li><a href="/topics/vue/cli.html" class="sidebar-link">第5章 CLI 构建工具</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第4章-进入vue原理"><a href="#第4章-进入vue原理" class="header-anchor">#</a> 第4章 进入vue原理</h1> <h2 id="_1、响应式原理"><a href="#_1、响应式原理" class="header-anchor">#</a> 1、响应式原理</h2> <h3 id="_1-对象的变化侦测"><a href="#_1-对象的变化侦测" class="header-anchor">#</a> (1) 对象的变化侦测</h3> <blockquote><p>下文提到的<code>状态</code>指数据单元。是<code>data</code>中定义的一个对象，同时也是对象里的每一个属性。</p></blockquote> <p>实现响应式的关键在于把所有数据及其属性变为可被侦测的，即在<code>get</code>和<code>set</code>时能被监测到，对于每一个状态通过<code>Observer</code>类来实现变化侦测，使用其<code>walk()</code>递归遍历对象的所有层级，通过<code>defineReactive()</code>调用<code>Object.defineProperty()</code>来实现侦测效果。对于每一个状态，有唯一的<code>Dept</code>用来管理其所有的依赖，之后在<code>get</code>时收集依赖，在<code>set</code>时通知依赖更新。这个依赖是什么呢？可能是一段<code>template</code>或者一个<code>watch</code>等，无论什么东西我们都用一个<code>Watcher</code>实例来代理，于是在状态发生变化时通知这个代理即可，由其再去触发生成新的<code>虚拟dom</code>，通过对比新旧虚拟dom，最小化更新真实dom。</p> <blockquote><p>在<code>vue 1.x</code>时使用的是细粒度的变化侦测，即依赖细化到每一个节点，此时根本不需要虚拟dom和diff的参与，因为已经足够知道需要更新哪些dom。但事实证明这种管理依赖的方法效率很低，因为太复杂。
从<code>vue 2.x</code>开始使用中粒度的变化侦测，依赖只细化到使用该状态的组件，组件内部自己去检查发生了究竟要更新哪部分dom。这样看起来繁琐了一些，但事实证明采取这种策略效率提升了非常多。你可能会疑惑状态就是在组件中声明的呀，只收集这个组件还有啥意义。状态的确是在组件中声明的，从一个组件实例也很容易找到他的所有状态，但从一个状态找到所有使用它的组件并不容易，状态并不是只在声明它的组件中使用！</p></blockquote> <h3 id="_2-数组的变化侦测"><a href="#_2-数组的变化侦测" class="header-anchor">#</a> (2) 数组的变化侦测</h3> <p>数组本身的变化侦测和对象有差异，因为我们使用方法来改变数组元素。为了不污染全局<code>Array.prototype</code>，只对需要变化侦测的数组使用拦截器作为<code>__proto__</code>来覆盖原型方法，对于不支持<code>__proto__</code>的浏览器，直接遍历拦截器的方法设置即可。</p> <h3 id="_3-vm-watch的实现"><a href="#_3-vm-watch的实现" class="header-anchor">#</a> (3) vm.$watch的实现</h3> <p><a href="https://weread.qq.com/web/reader/f8632810723f0231f86d9aakd3d322001ad3d9446802347" target="_blank" rel="noopener noreferrer">待看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>响应式发挥作用的前提只针对<code>data</code>中初始存在的数据。同时对于给对象添加、删除属性以及给数组元素赋新值也无法触发<code>set</code>，因为在<code>ES6</code>之前，js没有提供可以侦测到这种变化的<code>元编程</code>的能力。此时需要<code>Vue.set(obj, property/index, value)</code>和<code>Vue.delete()</code>手动加入响应式系统。</p></blockquote> <p><img src="https://cn.vuejs.org/images/data.png" alt="原理图"></p> <h2 id="_2、虚拟dom"><a href="#_2、虚拟dom" class="header-anchor">#</a> 2、虚拟dom</h2> <blockquote><p>原生html+js的前端页面也是有状态的，页面中使用的数据即是状态，当我们想要改变状态时，需要手动去更改使用这些状态的dom，因为dom和状态是没有依赖关系的。然而必须要明白一点，引入虚拟dom并没有真正优化操作dom的效率，只是在不想手动操作domn的场景下，引入虚拟dom这个中间层能带给程序一些细粒度的更新提示，不然只能完全重新渲染页面了。</p></blockquote> <p>虚拟dom是层次结构的<code>VNode</code>，它是个描述了如何去生成真实dom的节点描述对象。
具体实现是：模板被编译为render函数（涉及编译原理），该render函数就能在需要时生成当前模板对应的虚拟dom，进而转化为真实dom树并在页面渲染出来。当状态发生变化时，通知所有依赖重新render出虚拟dom，此时vue并不会把新生成的虚拟dom立即重新渲染出页面来，因为通过虚拟dom重新转化为真实dom本身也是个复杂的过程。因为dom树的属性太多，再者重新渲染整个dom到页面也是耗时的。所以vue的真实做法是对新旧dom进行细粒度的diff，找出最小差异，然后只根据这些差异去修改dom树，此时性能就提升了。
所以说虚拟dom其实是为了更好地diff。</p> <h2 id="_3、diff算法"><a href="#_3、diff算法" class="header-anchor">#</a> 3、Diff算法</h2> <p>diff出两个虚拟dom的差异，然后修改真实dom节点，这整个过程称为<code>patch</code>。即使用js的计算成本去换取DOM的操作成本。
<code>patchs = patch(oldVNode, newVNode)</code>
其实<code>patchs</code>就是得到的接下来的<code>dom操作</code>。
基本过程如下：新旧树逐层对比，先看节点类型，不同直接替换（删除旧的），相同再看属性是否要更新，之后递归diff过程。
显然任何dom树都能抽象为一个一维的结构，所以按照顺序依次比较两个<code>VNode</code>是能够得到修改方案，但这种粗暴的方案是非常低效的，尤其在涉及到增删dom时。
diff优化的策略坚持一下几个原则：</p> <ul><li>同层比较，永不跨层</li> <li>双指针法，两边向中间收拢。</li> <li>关键在于 key。</li> <li>命中策略依次为新前和旧前、新后和旧后、新后和旧前、新前与旧后。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/topics/vue/store.html" class="prev">
        第 3 章 vuex
      </a></span> <span class="next"><a href="/topics/vue/cli.html">
        第5章 CLI 构建工具
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3e77bb48.js" defer></script><script src="/assets/js/2.e6646181.js" defer></script><script src="/assets/js/33.f3b0c2ca.js" defer></script>
  </body>
</html>
